<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Converter</title>
    <script src="vendor/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="layout">
        <div class="main-column">
            <!-- Tabs Navigation -->
            <nav class="tabs-nav">
                <button class="tab-btn active" data-tab="xlsx-to-txt">XLSX → TXT</button>
                <button class="tab-btn" data-tab="txt-to-xlsx">TXT → XLSX</button>
                <button class="tab-btn" data-tab="xlsx-to-lokalise">XLSX → Lokalise</button>
            </nav>

            <!-- Tab 1: XLSX → TXT -->
            <div class="tab-content active" id="tab-xlsx-to-txt">
                <div class="section">
                    <h2>XLSX → TXT</h2>
                    <div class="form-row">
                        <input type="file" id="xlsxInput" accept=".xlsx">
                        <label for="xlsxOutputEncoding">Encoding:</label>
                        <select id="xlsxOutputEncoding">
                            <option value="macintosh" selected>Mac Roman</option>
                            <option value="utf-8">UTF-8</option>
                            <option value="windows-1252">Windows-1252</option>
                        </select>
                        <button id="xlsxToTxtBtn" disabled>Convert</button>
                    </div>
                    <div class="download-area" id="txtDownload"></div>
                    <div class="error" id="xlsxError"></div>
                </div>

                <ul class="note-list">
                    <li>Double spaces will be removed.</li>
                    <li>Line breaks will be removed.</li>
                    <li>The conversion date (YY-MM-DD) will be added automatically and will serve as the print material version.</li>
                    <li><label><input type="checkbox" id="ruleNumeric" checked> Numeric formatting</label></li>
                    <li><label><input type="checkbox" id="ruleUnitSpacing" checked> Unit spacing</label></li>
                    <li><label><input type="checkbox" id="ruleUnitCase" checked> Unit case normalization</label></li>
                    <li><label><input type="checkbox" id="ruleStripQuotes" checked> Strip outer quotes</label></li>
                    <li><label><input type="checkbox" id="ruleGlobal" checked> Global rules</label></li>
                    <li><label><input type="checkbox" id="ruleLanguage" checked> Language rules</label></li>
                    <li><button type="button" class="link-button" id="openRules">More information</button></li>
                </ul>

                <p class="note">Default encoding is Mac Roman. If you notice character issues in the output, please try a different encoding option.</p>
            </div>

            <!-- Tab 2: TXT → XLSX -->
            <div class="tab-content" id="tab-txt-to-xlsx">
                <div class="section">
                    <h2>TXT → XLSX</h2>
                    <div class="form-row">
                        <input type="file" id="txtInput" accept=".txt">
                        <label for="txtInputEncoding">Encoding:</label>
                        <select id="txtInputEncoding">
                            <option value="macintosh" selected>Mac Roman</option>
                            <option value="utf-8">UTF-8</option>
                            <option value="windows-1252">Windows-1252</option>
                        </select>
                        <button id="txtToXlsxBtn" disabled>Convert</button>
                    </div>
                    <div class="download-area" id="xlsxDownload"></div>
                    <div class="error" id="txtError"></div>
                </div>

                <ul class="note-list">
                    <li>The Date column will be removed during conversion.</li>
                    <li><label><input type="checkbox" id="ruleNumericTxt" checked> Numeric formatting</label></li>
                    <li><label><input type="checkbox" id="ruleUnitSpacingTxt" checked> Unit spacing</label></li>
                    <li><label><input type="checkbox" id="ruleUnitCaseTxt" checked> Unit case normalization</label></li>
                    <li><label><input type="checkbox" id="ruleStripQuotesTxt" checked> Strip outer quotes</label></li>
                    <li><label><input type="checkbox" id="ruleGlobalTxt" checked> Global rules</label></li>
                    <li><label><input type="checkbox" id="ruleLanguageTxt" checked> Language rules</label></li>
                </ul>

                <p class="note">Default encoding is Mac Roman. If you notice character issues in the output, please try a different encoding option.</p>
            </div>

            <!-- Tab 3: XLSX → Lokalise -->
            <div class="tab-content" id="tab-xlsx-to-lokalise">
                <div class="section">
                    <h2>Lokalise Export</h2>
                    <p class="note" style="text-align: left; margin: 0 0 16px;">
                        Upload an XLSX file with keys and source text (EN), then sync with a Lokalise project.
                    </p>

                    <div class="form-row">
                        <label for="apiToken">API Token:</label>
                        <input type="password" id="apiToken" class="token-input" placeholder="Enter Lokalise API token">
                        <button id="loadProjectsBtn" class="btn-secondary">Load Projects</button>
                    </div>
                    <p class="token-hint"><a href="https://app.lokalise.com/profile/#apitokens" target="_blank" rel="noopener">Where can I get it?</a></p>

                    <div class="form-row">
                        <label for="projectSelect">Project:</label>
                        <select id="projectSelect" class="project-select" disabled>
                            <option value="">— Select project —</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <input type="file" id="lokaliseXlsxInput" accept=".xlsx">
                    </div>

                    <div class="ops-checkboxes">
                        <label><input type="checkbox" id="opCreate" checked> Create new keys</label>
                        <label><input type="checkbox" id="opUpdate" checked> Update source (EN)</label>
                        <label><input type="checkbox" id="opDelete"> Delete missing keys</label>
                    </div>

                    <div class="btn-row">
                        <button id="previewBtn" disabled>Preview Diff</button>
                        <button id="runExportBtn" disabled>Run Export</button>
                    </div>

                    <div id="statusLine" class="status-line"></div>

                    <div id="previewSection" class="preview-section" style="display: none;">
                        <h4>Preview</h4>
                        <div id="previewContent"></div>
                    </div>
                </div>

                <ul class="note-list">
                    <li>XLSX format: Column A = key name, Column B = source text (EN).</li>
                    <li>First row should be headers (will be skipped).</li>
                    <li>API token is not saved anywhere.</li>
                    <li>Rate limit: max 6 requests/second.</li>
                </ul>
            </div>

            <!-- Rules Modal -->
            <div class="modal-overlay" id="rulesModal" aria-hidden="true">
                <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
                    <div class="modal-header">
                        <h3 class="modal-title" id="rulesTitle">NBSP Rules</h3>
                        <button type="button" class="modal-close" id="closeRules" aria-label="Close">✕</button>
                    </div>
                    <div class="modal-body" id="rulesContent">Loading...</div>
                </div>
            </div>
        </div>

        <aside class="log-panel">
            <div class="section">
                <div class="log-header">
                    <h2 id="logTitle">Conversion log</h2>
                    <span class="log-count" id="logCount">0 changes</span>
                </div>
                <p class="log-empty" id="logEmpty">No changes yet.</p>
                <ol class="log-list" id="logList"></ol>
            </div>
        </aside>
    </div>

    <script src="converter.js"></script>
    <script src="exporter.js"></script>
    <script>
        // Tabs functionality
        const tabTitles = {
            'xlsx-to-txt': 'XLSX → TXT log',
            'txt-to-xlsx': 'TXT → XLSX log',
            'xlsx-to-lokalise': 'Lokalise export log'
        };

        function activateTab(tabName) {
            const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            if (!btn) return;

            // Remove active from all buttons and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active to clicked button and corresponding content
            btn.classList.add('active');
            const tabId = 'tab-' + tabName;
            document.getElementById(tabId).classList.add('active');

            // Update log title based on active tab
            const logTitle = document.getElementById('logTitle');
            if (logTitle && tabTitles[tabName]) {
                logTitle.textContent = tabTitles[tabName];
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                activateTab(tabName);
                // Update URL hash without scrolling
                history.replaceState(null, '', '#' + tabName);
            });
        });

        // Activate tab from URL hash on page load
        const hash = window.location.hash.slice(1);
        if (hash && document.querySelector(`.tab-btn[data-tab="${hash}"]`)) {
            activateTab(hash);
        }

        // Handle browser back/forward navigation
        window.addEventListener('hashchange', () => {
            const newHash = window.location.hash.slice(1);
            if (newHash && document.querySelector(`.tab-btn[data-tab="${newHash}"]`)) {
                activateTab(newHash);
            }
        });
    </script>
</body>
</html>
